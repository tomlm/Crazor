@using CrazorDemoBot.Cards.ProductCatalog
@using System.Text;
@using System.Net.Http;
@using Newtonsoft.Json;

@inherits CardView<ProductCatalogApp>


<Card Version="1.5">
    <TextBlock Size="ExtraLarge" Weight="Bolder">Product Catalog</TextBlock>

    @if (CatalogItems.Any())
    {
        @foreach (var item in CatalogItems)
        {
            <Container Separator="true">
                <ColumnSet Padding="none">
                    <Column Width="stretch">
                        <TextBlock Size="Large" Weight="Bolder">@item.Name</TextBlock>
                        <TextBlock Size="Medium">@item.Description</TextBlock>
                        <TextBlock Size="Medium">Price: $@item.Price</TextBlock>
                        <Image Url="@item.PictureUri" />
                    </Column>
                    <Column Width="auto">
                        <Image Url="https://cdn.icon-icons.com/icons2/3399/PNG/512/detail_icon_215012.png" Size="Small">
                            <SelectAction>
                                <Action.Execute Tooltip="Detail" Verb="@nameof(OnDetail)">
                                    {"id":"@item.Id"}
                                </Action.Execute>
                            </SelectAction>
                        </Image>
                    </Column>
                    <Column Width="auto">
                        <Image Url="https://cdn.icon-icons.com/icons2/931/PNG/512/edit_modify_icon-icons.com_72390.png" Size="Small">
                            <SelectAction>
                                <Action.Execute Tooltip="Edit" Verb="@nameof(OnEdit)">
                                    {"id":"@item.Id"}
                                </Action.Execute>
                            </SelectAction>
                        </Image>
                    </Column>
                    <Column Width="auto">
                        <Image Url="https://cdn.icon-icons.com/icons2/3251/PNG/512/delete_regular_icon_203689.png" Size="Small">
                            <SelectAction>
                                <Action.Execute Tooltip="Delete" Verb="@nameof(OnDelete)">
                                    {"id":"@item.Id"}
                                </Action.Execute>
                            </SelectAction>
                        </Image>
                    </Column>
                </ColumnSet>
            </Container>
        }
    }

    <Action.Execute Title="Add Product Item" Verb="@nameof(OnAdd)" />
</Card>

@functions {
    
    public List<ProductCatalogItem> CatalogItems { get; set; }

    public async Task OnLoadView()
    {
        var request = "https://ordersapi.azurewebsites.net/api/orders";
        using (var client = new HttpClient())
        {
            var response = await client.GetStringAsync(request);

            CatalogItems = JsonConvert.DeserializeObject<List<ProductCatalogItem>>(response)!;
        }
    }

    public void OnAdd()
    {
        var item = new ProductCatalogItem();
        ShowView("EditOrAdd", new EditOrAddProductCatalogItem() { IsEdit = false, Item = item });
    }

    public void OnDetail(string id)
    {
        var item = CatalogItems.SingleOrDefault(a => a.Id == int.Parse(id));
        if (item != null)
        {
            ShowView("Detail", item);
        }
    }

    public void OnEdit(string id)
    {
        var item = CatalogItems.SingleOrDefault(a => a.Id == int.Parse(id));
        if (item != null)
        {
            ShowView("EditOrAdd", new EditOrAddProductCatalogItem() { IsEdit = true, Item = item });
        }
    }

    public void OnDelete(string id)
    {
        CatalogItems = CatalogItems.Where(a => a.Id != int.Parse(id)).ToList();
    }

    public async Task OnResume(CardResult cardResult, CancellationToken cancellationToken)
    {
        if (cardResult.Success)
        {
            if (cardResult.Name == "EditOrAdd")
            {
                var model = cardResult.AsResult<EditOrAddProductCatalogItem>()!;
                if (model.IsEdit)
                {
                    var item = CatalogItems.Where(a => a.Id == model.Item?.Id).SingleOrDefault();

                    if (item != null && model.Item != null)
                    {
                        // Update local copy
                        item.Name = model.Item.Name;
                        item.Description = model.Item.Description;
                        item.Price = model.Item.Price;
                        item.PictureUri = model.Item.PictureUri;
                        AddBannerMessage("Catalog Item successfully updated!", AdaptiveContainerStyle.Good);

                        // Update in API
                        var request = "https://ordersapi.azurewebsites.net/api/orders";
                        var data = JsonConvert.SerializeObject(item);
                        using (var client = new HttpClient())
                        {
                            var response = await client.PutAsync(request, new StringContent(data, Encoding.UTF8, "application/json"), cancellationToken);
                        }
                    }
                }
                else
                {
                    // Add local copy
                    if (model.Item != null)
                    {
                        CatalogItems.Add(model.Item);
                        AddBannerMessage("Catalog Item successfully added!", AdaptiveContainerStyle.Good);

                        // Update in API
                        var request = "https://ordersapi.azurewebsites.net/api/orders";
                        var data = JsonConvert.SerializeObject(model.Item);
                        using (var client = new HttpClient())
                        {
                            var response = await client.PostAsync(request, new StringContent(data, Encoding.UTF8, "application/json"), cancellationToken);
                        }
                    }
                }
            }
        }
    }

}
