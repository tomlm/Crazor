@using OpBot.Cards.Address
@using System.ComponentModel
@inherits CardView<EditAddressModel>

<Card xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" Version="1.5">
    @if (Model.IsEdit)
    {
        <TextBlock Size="ExtraLarge">Edit Address</TextBlock>
    }
    else
    {
        <TextBlock Size="ExtraLarge">Add Address</TextBlock>
    }

    <Input.Text Binding="@nameof(Street)" Style="Text" />
    <FieldErrors Id="@nameof(Street)" />

    <Input.Text Binding="@nameof(City)" Style="Text" />
    <FieldErrors Id="@nameof(City)" />

    <Input.ChoiceSet Binding="State">
        <Choice Title="Alabama" Value="AL" />
        <Choice Title="Arkansas" Value="AR" />
        <Choice Title="Alaska" Value="AK" />
        <Choice Title="California" Value="CA" />
        <Choice Title="Idaho" Value="ID" />
        <Choice Title="Washington" Value="WA" />
        <Choice Title="Iowa" Value="IA" />
        <Choice Title="Oregon" Value="OR" />
    </Input.ChoiceSet>
    <FieldErrors Id="@nameof(State)" />

    <Input.Text Binding="@nameof(PostalCode)" Style="Text" />
    <FieldErrors Id="@nameof(PostalCode)" />

    <Input.ChoiceSet Binding="Country" >
        <Choice Title="U.S.A." Value="USA" />
        <Choice Title="Canada" Value="CA" />
    </Input.ChoiceSet>
    <FieldErrors Id="@nameof(Country)" />

    <Action.Execute Title="Cancel" Verb="OnCancel" />
    <Action.Execute Title="Save" Verb="OnSave" />
</Card>

@functions {

    [BindProperty]
    [Required]
    [MaxLength(100)]
    public string? Street { get; set; }

    [BindProperty]
    [Required]
    [MaxLength(100)]
    public string? City { get; set; }

    [BindProperty]
    [Required]
    [MaxLength(30)]
    public string? State { get; set; }

    [BindProperty]
    [Required]
    [MaxLength(20)]
    [DisplayName("Zip")]
    public string? PostalCode { get; set; }

    [BindProperty]
    [Required]
    [MaxLength(50)]
    public string? Country { get; set; }

    public void OnInitialize()
    {
        if (Model.Address != null)
        {
            Street = Model.Address.Street;
            City = Model.Address.City;
            State = Model.Address.State;
            PostalCode = Model.Address.PostalCode;
            Country = Model.Address.Country;
        }
    }

    public void OnSave()
    {
        if (this.IsModelValid)
        {
            ArgumentNullException.ThrowIfNull(Model.Address);
            Model.Address.Street = Street;
            Model.Address.City = City;
            Model.Address.State = State;
            Model.Address.PostalCode = PostalCode;
            Model.Address.Country = Country;

            this.Close(Model);
        }
    }

    public void OnCancel()
    {
        this.Cancel("No changes made.");
    }
}