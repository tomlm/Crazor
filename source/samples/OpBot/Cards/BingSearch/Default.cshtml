@using Microsoft.Bing.WebSearch
@using Microsoft.Bing.WebSearch.Models
@using Microsoft.Extensions.Configuration
@using OpBot.Cards.BingSearch
@inherits CardView<BingSearchApp, SearchModel>

<Card xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" Version="1.5">
    <TextBlock Size="ExtraLarge" Weight="Bolder">Bing Search</TextBlock>
    <ColumnSet>
        <Column Width="stretch">
            <Input.Text Binding="Model.Query" Label="" Placeholder="Enter search terms"/>
        </Column>
        <Column Width="auto">
            <ActionSet>
                <Action.Execute Title="Search" Verb="OnSearch" />
            </ActionSet>
        </Column>
    </ColumnSet>
    <ColumnSet>
        <Column Width="auto">
            @if (HasPrev())
            {
                <ActionSet>
                    <Action.Execute Title="<" Verb="OnPrevious" />
                </ActionSet>
            }
        </Column>
        <Column Width="stretch" />
        <Column Width="auto">
            @if (HasNext())
            {
                <ActionSet>
                    <Action.Execute Title=">" Verb="OnNext" />
                </ActionSet>
            }
        </Column>
    </ColumnSet>
    if (Results != null)
    {
    @foreach (var result in Results)
    {
        <Container Separator="true">
            <ColumnSet>
                <Column Width="stretch">
                    <TextBlock Weight="Bolder">[@result.Name](@result.DisplayUrl)</TextBlock>
                    <TextBlock Spacing="None">[@result.DisplayUrl](@result.DisplayUrl)</TextBlock>
                    <TextBlock Spacing="Small">@result.Snippet</TextBlock>
                </Column>
                <Column Width="auto">
                    @if (!String.IsNullOrEmpty(result.ThumbnailUrl))
                    {
                        <Image Url="@result.ThumbnailUrl" Size="Large" />
                    }
                </Column>
            </ColumnSet>
        </Container>
    }
    }
</Card>

@functions {
    public const int PageSize = 5;

    public IList<WebPage> Results { get; set; } = new List<WebPage>();

    public bool HasNext() => Results.Any();

    public bool HasPrev() => Results.Any() && Model.Offset > 0;

    public async Task OnSearchAsync()
    {
        if (!String.IsNullOrWhiteSpace(Model.Query))
        {
            var configuration = (IConfiguration)ViewContext.HttpContext.RequestServices.GetService(typeof(IConfiguration))!;
            var apiKey = configuration.GetValue<string>("BingKey");
            var search = new WebSearchClient(new ApiKeyServiceClientCredentials(apiKey));

            var searchResult = await search.Web.SearchAsync(query: Model.Query, count: PageSize, offset: Model.Offset);

            Results = searchResult.WebPages.Value!;
        }
    }

    public async Task OnNextAsync()
    {
        Model.Offset += PageSize;
        await OnSearchAsync();
    }

    public async Task OnPreviousAsync()
    {
        if (Model.Offset != 0)
            Model.Offset -= PageSize;
        await OnSearchAsync();
    }
}
